<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; connect-src 'self' ws: wss:; img-src 'self' data:;">
  <title>SSHå®¢æˆ·ç«¯</title>
  <link rel="stylesheet" href="styles/main.css">
  <link rel="stylesheet" href="styles/fix-buttons.css">
  <link rel="stylesheet" href="node_modules/@xterm/xterm/css/xterm.css">
  <script>
    // ç¡®ä¿ window.xtermJS åœ¨ä½¿ç”¨å‰å·²å®šä¹‰
    window.xtermJS = window.xtermJS || {};
  </script>
</head>
<body>
  <!-- ä½¿ç”¨åŸç”Ÿæ„å»ºçš„ç®€æ˜“UIï¼Œé¿å…Vueç›¸å…³é”™è¯¯ -->
  <div id="app">
    <div class="layout">
      <!-- ä¾§è¾¹æ  -->
      <div class="sidebar">
        <div class="sidebar-header">
          <h3>è¿æ¥ç®¡ç†</h3>
          <button id="toggle-sidebar" class="toggle-btn">Â«</button>
        </div>
        
        <div class="connection-list" id="connection-list">
          <!-- è¿æ¥åˆ—è¡¨å°†ç”±JavaScriptåŠ¨æ€å¡«å…… -->
        </div>
        
        <div class="sidebar-footer">
          <button id="add-connection-btn" class="sidebar-btn add-btn" type="button">
            <span class="icon">+</span><span class="btn-text">æ·»åŠ è¿æ¥</span>
          </button>
          <button id="settings-btn" class="sidebar-btn settings-btn">
            <span class="icon">âš™</span> <span class="btn-text">è®¾ç½®</span>
          </button>
        </div>
      </div>
      
      <!-- ä¸»ç•Œé¢åŒºåŸŸ -->
      <div class="main-content">
        <!-- æ ‡ç­¾é¡µ -->
        <div class="tabs" id="tabs-container">
          <!-- æ ‡ç­¾é¡µå°†ç”±JavaScriptåŠ¨æ€å¡«å…… -->
        </div>
        
        <!-- ç»ˆç«¯å®¹å™¨ -->
        <div class="terminals-container" id="terminals-container">
          <!-- ç»ˆç«¯å°†ç”±JavaScriptåŠ¨æ€å¡«å…… -->
        </div>
      </div>
    </div>
    
    <!-- è¿æ¥è¡¨å•æ¨¡æ€æ¡† -->
    <div class="modal" id="connection-modal" style="display: none;">
      <div class="modal-content">
        <span class="close" id="close-modal">&times;</span>
        <h2 id="modal-title">æ–°å»ºè¿æ¥</h2>
        
        <div class="form-group">
          <label for="name">åç§°</label>
          <input type="text" id="name" required>
        </div>
        
        <div class="form-group">
          <label for="host">ä¸»æœº</label>
          <input type="text" id="host" required>
        </div>
        
        <div class="form-group">
          <label for="port">ç«¯å£</label>
          <input type="number" id="port" value="22" required>
        </div>
        
        <div class="form-group">
          <label for="username">ç”¨æˆ·å</label>
          <input type="text" id="username" required>
        </div>
        
        <div class="form-group">
          <label for="authType">è®¤è¯ç±»å‹</label>
          <select id="authType">
            <option value="password">å¯†ç </option>
            <option value="privateKey">ç§é’¥</option>
          </select>
        </div>
        
        <div class="form-group" id="password-group">
          <label for="password">å¯†ç </label>
          <input type="password" id="password">
        </div>
        
        <div class="form-group" id="privatekey-group" style="display: none;">
          <label for="privateKey">ç§é’¥è·¯å¾„</label>
          <input type="text" id="privateKey">
          
          <label for="passphrase">å¯†ç çŸ­è¯­ (å¯é€‰)</label>
          <input type="password" id="passphrase">
        </div>
        
        <div class="form-buttons">
          <button type="button" id="save-connection" class="save-btn">ä¿å­˜</button>
          <button type="button" id="cancel-connection" class="cancel-btn">å–æ¶ˆ</button>
        </div>
      </div>
    </div>
    
    <!-- ä¸Šä¸‹æ–‡èœå• -->
    <div class="context-menu" id="context-menu" style="display: none; position: fixed; z-index: 1001;">
      <div class="menu-item" id="edit-connection">ç¼–è¾‘</div>
      <div class="menu-item" id="duplicate-connection">å¤åˆ¶</div>
      <div class="menu-item delete" id="delete-connection">åˆ é™¤</div>
    </div>
  </div>
  
  <!-- å¼•å…¥æ ‡å‡†è„šæœ¬ -->
  <script>
    // å½“DOMåŠ è½½å®Œæˆåæ‰§è¡Œ
    document.addEventListener('DOMContentLoaded', function() {
      // è·å–DOMå…ƒç´ 
      const addConnectionBtn = document.getElementById('add-connection-btn');
      const connectionModal = document.getElementById('connection-modal');
      const closeModal = document.getElementById('close-modal');
      const saveConnection = document.getElementById('save-connection');
      const cancelConnection = document.getElementById('cancel-connection');
      const authTypeSelect = document.getElementById('authType');
      const passwordGroup = document.getElementById('password-group');
      const privatekeyGroup = document.getElementById('privatekey-group');
      const connectionList = document.getElementById('connection-list');
      const tabsContainer = document.getElementById('tabs-container');
      const terminalsContainer = document.getElementById('terminals-container');
      const contextMenu = document.getElementById('context-menu');
      const editConnection = document.getElementById('edit-connection');
      const duplicateConnection = document.getElementById('duplicate-connection');
      const deleteConnection = document.getElementById('delete-connection');
      const toggleSidebar = document.getElementById('toggle-sidebar');
      
      let connections = [];
      let activeTab = -1;
      let terminals = [];
      let sshClients = [];
      let currentConnectionForContext = null;
      let isEditing = false;
      let editingConnection = null;
      
      // åˆ‡æ¢è®¤è¯ç±»å‹æ˜¾ç¤º
      authTypeSelect.addEventListener('change', function() {
        if (this.value === 'password') {
          passwordGroup.style.display = 'block';
          privatekeyGroup.style.display = 'none';
        } else {
          passwordGroup.style.display = 'none';
          privatekeyGroup.style.display = 'block';
        }
      });
      
      // æ˜¾ç¤ºè¿æ¥æ¨¡æ€æ¡†
      addConnectionBtn.addEventListener('click', function() {
        // é‡ç½®è¡¨å•
        document.getElementById('name').value = '';
        document.getElementById('host').value = '';
        document.getElementById('port').value = '22';
        document.getElementById('username').value = '';
        document.getElementById('password').value = '';
        document.getElementById('privateKey').value = '';
        document.getElementById('passphrase').value = '';
        authTypeSelect.value = 'password';
        passwordGroup.style.display = 'block';
        privatekeyGroup.style.display = 'none';
        
        // è®¾ç½®ä¸ºæ–°å»ºæ¨¡å¼
        isEditing = false;
        editingConnection = null;
        document.getElementById('modal-title').textContent = 'æ–°å»ºè¿æ¥';
        
        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        connectionModal.style.display = 'flex';
      });
      
      // å…³é—­æ¨¡æ€æ¡†
      closeModal.addEventListener('click', function() {
        connectionModal.style.display = 'none';
      });
      cancelConnection.addEventListener('click', function() {
        connectionModal.style.display = 'none';
      });
      
      // ä¿å­˜è¿æ¥
      saveConnection.addEventListener('click', function() {
        // è·å–è¡¨å•æ•°æ®
        const name = document.getElementById('name').value;
        const host = document.getElementById('host').value;
        const port = parseInt(document.getElementById('port').value, 10);
        const username = document.getElementById('username').value;
        const authType = authTypeSelect.value;
        const password = document.getElementById('password').value;
        const privateKey = document.getElementById('privateKey').value;
        const passphrase = document.getElementById('passphrase').value;
        
        // éªŒè¯å¿…å¡«å­—æ®µ
        if (!name || !host || !port || !username || 
            (authType === 'password' && !password) || 
            (authType === 'privateKey' && !privateKey)) {
          alert('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ');
          return;
        }
        
        // åˆ›å»ºè¿æ¥å¯¹è±¡
        const connection = {
          name,
          host,
          port,
          username,
          authType,
          password: authType === 'password' ? password : '',
          privateKey: authType === 'privateKey' ? privateKey : '',
          passphrase: authType === 'privateKey' ? passphrase : ''
        };
        
        // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
        if (window.electron) {
          window.electron.saveConnection(connection);
        } else {
          // æ¨¡æ‹Ÿä¿å­˜è¡Œä¸ºï¼ˆå½“electron APIä¸å¯ç”¨æ—¶ï¼‰
          if (isEditing && editingConnection) {
            const index = connections.findIndex(c => c.name === editingConnection.name);
            if (index >= 0) {
              connections[index] = connection;
            }
          } else {
            connections.push(connection);
          }
          renderConnectionList();
        }
        
        // å…³é—­æ¨¡æ€æ¡†
        connectionModal.style.display = 'none';
      });
      
      // åˆ‡æ¢ä¾§è¾¹æ 
      toggleSidebar.addEventListener('click', function() {
        const sidebar = document.querySelector('.sidebar');
        sidebar.classList.toggle('collapsed');
        this.textContent = sidebar.classList.contains('collapsed') ? 'Â»' : 'Â«';
      });
      
      // ç‚¹å‡»bodyæ—¶éšè—ä¸Šä¸‹æ–‡èœå•
      document.body.addEventListener('click', function() {
        contextMenu.style.display = 'none';
      });
      
      // åŠ è½½è¿æ¥åˆ—è¡¨
      function loadConnections() {
        if (window.electron) {
          window.electron.getConnections();
          window.electron.on('connections-loaded', function(loadedConnections) {
            connections = loadedConnections;
            renderConnectionList();
          });
        }
      }
      
      // æ¸²æŸ“è¿æ¥åˆ—è¡¨
      function renderConnectionList() {
        connectionList.innerHTML = '';
        connections.forEach(function(conn) {
          const item = document.createElement('div');
          item.className = 'connection-item';
          
          // æ·»åŠ è¿æ¥å›¾æ ‡
          const icon = document.createElement('span');
          icon.className = 'icon';
          icon.textContent = 'ğŸ–¥ï¸';
          icon.style.marginRight = '8px';
          item.appendChild(icon);
          
          // æ·»åŠ è¿æ¥åç§°æ–‡æœ¬
          const text = document.createElement('span');
          text.className = 'connection-name';
          text.textContent = `${conn.name} (${conn.host})`;
          item.appendChild(text);
          
          // æ·»åŠ æ“ä½œæŒ‰é’®å®¹å™¨
          const actions = document.createElement('div');
          actions.className = 'connection-actions';
          
          // æ·»åŠ ç¼–è¾‘å›¾æ ‡
          const editIcon = document.createElement('span');
          editIcon.className = 'action-icon edit-icon';
          editIcon.textContent = 'âœï¸';
          editIcon.title = 'ç¼–è¾‘è¿æ¥';
          editIcon.addEventListener('click', function(event) {
            event.stopPropagation(); // é˜»æ­¢å†’æ³¡ï¼Œé¿å…è§¦å‘è¿æ¥æ“ä½œ
            editConnectionHandler(conn);
          });
          actions.appendChild(editIcon);
          
          // æ·»åŠ è¿æ¥å›¾æ ‡
          const connectIcon = document.createElement('span');
          connectIcon.className = 'action-icon connect-icon';
          connectIcon.textContent = 'â–¶ï¸';
          connectIcon.title = 'è¿æ¥åˆ°æœåŠ¡å™¨';
          connectIcon.addEventListener('click', function(event) {
            event.stopPropagation(); // é˜»æ­¢å†’æ³¡
            connectToServer(conn);
          });
          actions.appendChild(connectIcon);
          
          item.appendChild(actions);
          
          // è®¾ç½®å·¥å…·æç¤ºï¼Œåœ¨æ”¶èµ·æ—¶æ˜¾ç¤ºè¿æ¥åç§°
          item.title = `${conn.name} (${conn.host})`;
          
          // ç‚¹å‡»è¿æ¥åˆ°æœåŠ¡å™¨
          item.addEventListener('click', function() {
            connectToServer(conn);
          });
          
          // å³é”®æ˜¾ç¤ºä¸Šä¸‹æ–‡èœå•
          item.addEventListener('contextmenu', function(event) {
            event.preventDefault();
            showContextMenu(event, conn);
          });
          
          connectionList.appendChild(item);
        });
      }
      
      // å¤„ç†ç¼–è¾‘è¿æ¥
      function editConnectionHandler(conn) {
        // å¡«å……è¡¨å•
        document.getElementById('name').value = conn.name;
        document.getElementById('host').value = conn.host;
        document.getElementById('port').value = conn.port;
        document.getElementById('username').value = conn.username;
        document.getElementById('authType').value = conn.authType;
        document.getElementById('password').value = conn.password || '';
        document.getElementById('privateKey').value = conn.privateKey || '';
        document.getElementById('passphrase').value = conn.passphrase || '';
        
        // æ˜¾ç¤º/éšè—è®¤è¯å­—æ®µ
        if (conn.authType === 'password') {
          passwordGroup.style.display = 'block';
          privatekeyGroup.style.display = 'none';
        } else {
          passwordGroup.style.display = 'none';
          privatekeyGroup.style.display = 'block';
        }
        
        // è®¾ç½®ä¸ºç¼–è¾‘æ¨¡å¼
        isEditing = true;
        editingConnection = conn;
        document.getElementById('modal-title').textContent = 'ç¼–è¾‘è¿æ¥';
        
        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        connectionModal.style.display = 'flex';
      }
      
      // æ˜¾ç¤ºä¸Šä¸‹æ–‡èœå•
      function showContextMenu(event, conn) {
        contextMenu.style.top = `${event.clientY}px`;
        contextMenu.style.left = `${event.clientX}px`;
        contextMenu.style.display = 'block';
        currentConnectionForContext = conn;
        
        // é˜»æ­¢å†’æ³¡ï¼Œé¿å…ç«‹å³éšè—èœå•
        event.stopPropagation();
      }
      
      // ç¼–è¾‘è¿æ¥
      editConnection.addEventListener('click', function() {
        if (!currentConnectionForContext) return;
        
        // å¡«å……è¡¨å•
        document.getElementById('name').value = currentConnectionForContext.name;
        document.getElementById('host').value = currentConnectionForContext.host;
        document.getElementById('port').value = currentConnectionForContext.port;
        document.getElementById('username').value = currentConnectionForContext.username;
        document.getElementById('authType').value = currentConnectionForContext.authType;
        document.getElementById('password').value = currentConnectionForContext.password || '';
        document.getElementById('privateKey').value = currentConnectionForContext.privateKey || '';
        document.getElementById('passphrase').value = currentConnectionForContext.passphrase || '';
        
        // æ˜¾ç¤º/éšè—è®¤è¯å­—æ®µ
        if (currentConnectionForContext.authType === 'password') {
          passwordGroup.style.display = 'block';
          privatekeyGroup.style.display = 'none';
        } else {
          passwordGroup.style.display = 'none';
          privatekeyGroup.style.display = 'block';
        }
        
        // è®¾ç½®ä¸ºç¼–è¾‘æ¨¡å¼
        isEditing = true;
        editingConnection = currentConnectionForContext;
        document.getElementById('modal-title').textContent = 'ç¼–è¾‘è¿æ¥';
        
        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        connectionModal.style.display = 'flex';
        contextMenu.style.display = 'none';
      });
      
      // å¤åˆ¶è¿æ¥
      duplicateConnection.addEventListener('click', function() {
        if (!currentConnectionForContext) return;
        
        const duplicate = {...currentConnectionForContext};
        duplicate.name = `${duplicate.name} (å¤åˆ¶)`;
        
        if (window.electron) {
          window.electron.saveConnection(duplicate);
        } else {
          connections.push(duplicate);
          renderConnectionList();
        }
        
        contextMenu.style.display = 'none';
      });
      
      // åˆ é™¤è¿æ¥
      deleteConnection.addEventListener('click', function() {
        if (!currentConnectionForContext) return;
        
        if (confirm(`ç¡®å®šè¦åˆ é™¤è¿æ¥ "${currentConnectionForContext.name}" å—ï¼Ÿ`)) {
          if (window.electron) {
            window.electron.deleteConnection(currentConnectionForContext.name);
          } else {
            connections = connections.filter(c => c.name !== currentConnectionForContext.name);
            renderConnectionList();
          }
        }
        
        contextMenu.style.display = 'none';
      });
      
      // è¿æ¥åˆ°æœåŠ¡å™¨
      function connectToServer(connection) {
        // åˆ›å»ºæ–°æ ‡ç­¾é¡µ
        const tabIndex = addTab(connection.name);
        
        // åˆ‡æ¢åˆ°æ–°æ ‡ç­¾é¡µ
        switchTab(tabIndex);
        
        // åˆ›å»ºç»ˆç«¯
        setTimeout(function() {
          createTerminal(tabIndex, connection);
        }, 100);
      }
      
      // æ·»åŠ æ ‡ç­¾é¡µ
      function addTab(name) {
        const tabIndex = tabsContainer.children.length;
        
        const tab = document.createElement('div');
        tab.className = 'tab';
        tab.dataset.index = tabIndex;
        
        const tabName = document.createElement('span');
        tabName.textContent = name;
        tab.appendChild(tabName);
        
        const closeButton = document.createElement('span');
        closeButton.className = 'close-tab';
        closeButton.textContent = 'Ã—';
        closeButton.addEventListener('click', function(event) {
          event.stopPropagation();
          closeTab(tabIndex);
        });
        tab.appendChild(closeButton);
        
        tab.addEventListener('click', function() {
          switchTab(parseInt(this.dataset.index, 10));
        });
        
        tabsContainer.appendChild(tab);
        
        // åˆ›å»ºç»ˆç«¯å®¹å™¨
        const terminalWrapper = document.createElement('div');
        terminalWrapper.className = 'terminal-wrapper';
        terminalWrapper.style.display = 'none';
        
        const terminalElement = document.createElement('div');
        terminalElement.id = `terminal-${tabIndex}`;
        terminalElement.className = 'terminal';
        
        terminalWrapper.appendChild(terminalElement);
        terminalsContainer.appendChild(terminalWrapper);
        
        return tabIndex;
      }
      
      // åˆ‡æ¢æ ‡ç­¾é¡µ
      function switchTab(index) {
        // æ›´æ–°æ´»åŠ¨æ ‡ç­¾
        activeTab = index;
        
        // æ›´æ–°æ ‡ç­¾æ ·å¼
        const tabs = tabsContainer.children;
        for (let i = 0; i < tabs.length; i++) {
          if (i === index) {
            tabs[i].classList.add('active');
          } else {
            tabs[i].classList.remove('active');
          }
        }
        
        // æ›´æ–°ç»ˆç«¯æ˜¾ç¤º
        const terminalWrappers = terminalsContainer.children;
        for (let i = 0; i < terminalWrappers.length; i++) {
          if (i === index) {
            terminalWrappers[i].style.display = 'block';
          } else {
            terminalWrappers[i].style.display = 'none';
          }
        }
        
        // è°ƒæ•´ç»ˆç«¯å¤§å°
        if (terminals[index] && terminals[index].fitAddon) {
          setTimeout(function() {
            try {
              terminals[index].fitAddon.fit();
            } catch (e) {
              console.error('è°ƒæ•´ç»ˆç«¯å¤§å°å¤±è´¥:', e);
            }
          }, 0);
        }
      }
      
      // å…³é—­æ ‡ç­¾é¡µ
      function closeTab(index) {
        // å…³é—­SSHè¿æ¥
        if (sshClients[index]) {
          try {
            if (sshClients[index].dispose) {
              sshClients[index].dispose();
            }
          } catch (e) {
            console.error('å…³é—­SSHè¿æ¥å¤±è´¥:', e);
          }
        }
        
        // é”€æ¯ç»ˆç«¯
        if (terminals[index] && terminals[index].term) {
          try {
            terminals[index].term.dispose();
          } catch (e) {
            console.error('é”€æ¯ç»ˆç«¯å¤±è´¥:', e);
          }
        }
        
        // åˆ é™¤DOMå…ƒç´ 
        tabsContainer.removeChild(tabsContainer.children[index]);
        terminalsContainer.removeChild(terminalsContainer.children[index]);
        
        // æ›´æ–°ç´¢å¼•
        for (let i = index + 1; i < tabsContainer.children.length + 1; i++) {
          if (tabsContainer.children[i - 1]) {
            tabsContainer.children[i - 1].dataset.index = i - 1;
          }
        }
        
        // æ›´æ–°æ•°ç»„
        terminals.splice(index, 1);
        sshClients.splice(index, 1);
        
        // æ›´æ–°æ´»åŠ¨æ ‡ç­¾é¡µ
        if (activeTab === index) {
          if (index > 0) {
            switchTab(index - 1);
          } else if (tabsContainer.children.length > 0) {
            switchTab(0);
          } else {
            activeTab = -1;
          }
        } else if (activeTab > index) {
          switchTab(activeTab - 1);
        }
      }
      
      // åˆ›å»ºç»ˆç«¯
      async function createTerminal(index, connection) {
        try {
          console.log('å¼€å§‹åˆ›å»ºç»ˆç«¯...');
          
          // æ£€æŸ¥æ¨¡å—æ˜¯å¦å¯ç”¨
          if (!window.xtermJS || !window.xtermJS.createTerminalElement) {
            console.error('xtermJS å¯¹è±¡ä¸å­˜åœ¨æˆ–ä¸å®Œæ•´');
            throw new Error('ç»ˆç«¯ç»„ä»¶æœªåŠ è½½');
          }
          
          console.log('xtermJS version:', window.xtermJS.version);
          
          // ç»ˆç«¯å…ƒç´  ID
          const terminalElementId = `terminal-${index}`;
          
          // åˆ›å»ºç»ˆç«¯å®ä¾‹ï¼ˆå•æ­¥å®Œæˆæ‰€æœ‰æ“ä½œï¼‰
          const term = window.xtermJS.createTerminalElement(terminalElementId, {
            cursorBlink: true,
            fontSize: 14,
            fontFamily: 'Menlo, Monaco, Courier New, monospace',
            theme: {
              background: '#1e1e1e',
              foreground: '#f0f0f0'
            },
            scrollback: 1000,
            allowProposedApi: true
          });
          
          console.log('ç»ˆç«¯åˆ›å»ºæˆåŠŸ:', term.id);
          
          // è°ƒæ•´ç»ˆç«¯å¤§å°
          try {
            console.log('è°ƒæ•´ç»ˆç«¯å¤§å°...');
            term.fit();
            
            // ç›‘å¬å®¹å™¨å¤§å°å˜åŒ–
            const terminalElement = document.getElementById(terminalElementId);
            const resizeObserver = new ResizeObserver(() => {
              try {
                term.fit();
              } catch (e) {
                console.error('è‡ªåŠ¨è°ƒæ•´ç»ˆç«¯å¤§å°å¤±è´¥:', e);
              }
            });
            
            resizeObserver.observe(terminalElement);
          } catch (e) {
            console.error('åˆå§‹è°ƒæ•´ç»ˆç«¯å¤§å°å¤±è´¥:', e);
          }
          
          // ä¿å­˜ç»ˆç«¯å®ä¾‹
          terminals[index] = { term };
          
          // æ˜¾ç¤ºè¿æ¥ä¿¡æ¯
          term.write(`æ­£åœ¨è¿æ¥åˆ° ${connection.host}:${connection.port}...\r\n`);
          
          try {
            // è¿æ¥åˆ°SSHæœåŠ¡å™¨
            const result = await window.electron.connectSSH(connection);
            console.log('SSHè¿æ¥ç»“æœ:', result);
            
            // è®¾ç½®ç»ˆç«¯è¾“å…¥äº‹ä»¶
            term.onData(function(data) {
              window.electron.sendSSHData(result.id, data);
            });
            
            // ç›‘å¬SSHæ•°æ®
            window.electron.onSSHData(result.id, (data) => {
              term.write(data);
            });
            
            // ä¿å­˜SSHå®¢æˆ·ç«¯ID
            sshClients[index] = {
              id: result.id,
              dispose: async function() {
                try {
                  await window.electron.disconnectSSH(result.id);
                  console.log('å·²æ–­å¼€è¿æ¥');
                } catch (e) {
                  console.error('æ–­å¼€è¿æ¥å¤±è´¥:', e);
                }
              }
            };
            
          } catch (error) {
            console.error('SSHè¿æ¥å¤±è´¥:', error);
            term.write(`\r\n\x1b[31mè¿æ¥å¤±è´¥: ${error.message}\x1b[0m\r\n`);
          }
          
        } catch (error) {
          console.error('åˆ›å»ºç»ˆç«¯æ—¶å‡ºé”™:', error);
          alert(`åˆ›å»ºç»ˆç«¯å¤±è´¥: ${error.message}`);
        }
      }
      
      // è°ƒæ•´çª—å£å¤§å°æ—¶é‡æ–°è°ƒæ•´ç»ˆç«¯
      window.addEventListener('resize', function() {
        if (activeTab >= 0 && terminals[activeTab] && terminals[activeTab].fitAddon) {
          try {
            terminals[activeTab].fitAddon.fit();
          } catch (e) {
            console.error('è°ƒæ•´ç»ˆç«¯å¤§å°å¤±è´¥:', e);
          }
        }
      });
      
      // åˆå§‹åŒ–
      loadConnections();
    });
  </script>
</body>
</html>
